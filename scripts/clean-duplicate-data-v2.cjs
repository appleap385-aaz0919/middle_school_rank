const fs = require('fs');
const path = require('path');

/**
 * 스크래핑 데이터 중복 제거 및 정체 (개선 버전)
 *
 * 문제: 페이지 전환이 제대로 되지 않아 이전 지역 데이터가 중복 수집됨
 * 해결: 각 지역별 예상 학교 수를 기준으로 데이터 자르기
 */
function cleanDuplicateDataV2() {
  console.log('=== 스크래핑 데이터 정제 v2 시작 ===\n');

  // 백업 파일 확인 후 사용, 없으면 원본 사용
  const backupPath = path.join(__dirname, '../src/data/schoolAlimData_backup.json');
  const originalPath = path.join(__dirname, '../src/data/schoolAlimData.json');
  const dataSource = fs.existsSync(backupPath) ? backupPath : originalPath;

  console.log(`1. 데이터 로드 중... (${path.basename(dataSource)})`);
  const rawData = fs.readFileSync(dataSource, 'utf8');
  const asilData = JSON.parse(rawData);

  const year = '2025';
  const regions = asilData[year] || {};

  console.log(`   - ${Object.keys(regions).length}개 지역 데이터 로드 완료\n`);

  // 각 지역별 예상 학교 수
  const expectedCounts = {
    // 서울 (약 350개교)
    '서울특별시 강남구': 25, '서울특별시 강동구': 17, '서울특별시 강북구': 13,
    '서울특별시 강서구': 22, '서울특별시 관악구': 16, '서울특별시 광진구': 14,
    '서울특별시 구로구': 13, '서울특별시 금천구': 9, '서울특별시 노원구': 26,
    '서울특별시 도봉구': 13, '서울특별시 동대문구': 15, '서울특별시 동작구': 16,
    '서울특별시 마포구': 14, '서울특별시 서대문구': 14, '서울특별시 서초구': 15,
    '서울특별시 성동구': 11, '서울특별시 성북구': 18, '서울특별시 송파구': 27,
    '서울특별시 양천구': 19, '서울특별시 영등포구': 11, '서울특별시 용산구': 9,
    '서울특별시 은평구': 18, '서울특별시 종로구': 9, '서울특별시 중구': 8,
    '서울특별시 중랑구': 12,
    // 부산 (약 140개교)
    '부산광역시 강서구': 12, '부산광역시 금정구': 15, '부산광역시 남구': 9,
    '부산광역시 동구': 6, '부산광역시 동래구': 16, '부산광역시 부산진구': 10,
    '부산광역시 북구': 12, '부산광역시 사상구': 11, '부산광역시 사하구': 10,
    '부산광역시 서구': 6, '부산광역시 수영구': 11, '부산광역시 연제구': 10,
    '부산광역시 영도구': 7, '부산광역시 중구': 5, '부산광역시 해운대구': 18,
    // 대구 (약 90개교)
    '대구광역시 남구': 8, '대구광역시 달서구': 20, '대구광역시 동구': 7,
    '대구광역시 북구': 14, '대구광역시 서구': 9, '대구광역시 수성구': 19,
    '대구광역시 중구': 7,
    // 인천 (약 120개교)
    '인천광역시 강화군': 4, '인천광역시 계양구': 14, '인천광역시 남동구': 17,
    '인천광역시 동구': 5, '인천광역시 미추홀구': 21, '인천광역시 부평구': 20,
    '인천광역시 서구': 8, '인천광역시 연수구': 12, '인천광역시 옹진군': 4,
    '인천광역시 중구': 5,
    // 광주 (약 70개교)
    '광주광역시 광산구': 19, '광주광역시 남구': 9, '광주광역시 동구': 7,
    '광주광역시 북구': 16, '광주광역시 서구': 12,
    // 대전 (약 60개교)
    '대전광역시 대덕구': 8, '대전광역시 동구': 8, '대전광역시 서구': 13,
    '대전광역시 유성구': 16, '대전광역시 중구': 8,
    // 울산 (약 50개교)
    '울산광역시 남구': 10, '울산광역시 동구': 6, '울산광역시 북구': 13,
    '울산광역시 울주군': 7, '울산광역시 중구': 6,
    // 세종 (약 20개교)
    '세종특별자치시 세종특별자치시': 18,
    // 경기 (약 700개교) - 시군구별
    '경기도 가평군': 12, '경기도 고양시': 45, '경기도 과천시': 7,
    '경기도 광명시': 11, '경기도 광주시': 18, '경기도 구리시': 15,
    '경기도 군포시': 13, '경기도 김포시': 20, '경기도 남양주시': 30,
    '경기도 동두천시': 6, '경기도 부천시': 35, '경기도 성남시': 30,
    '경기도 수원시': 40, '경기도 시흥시': 22, '경기도 안산시': 35,
    '경기도 안성시': 12, '경기도 안양시': 30, '경기도 양주시': 10,
    '경기도 양평군': 12, '경기도 여주시': 13, '경기도 연천군': 6,
    '경기도 오산시': 9, '경기도 용인시': 50, '경기도 의왕시': 7,
    '경기도 의정부시': 25, '경기도 이천시': 16, '경기도 파주시': 16,
    '경기도 평택시': 35, '경기도 포천시': 14, '경기도 하남시': 18,
    '경기도 화성시': 29,
    // 강원 (약 150개교)
    '강원도 강릉시': 16, '강원도 고성군': 4, '강원도 동해시': 8,
    '강원도 삼척시': 8, '강원도 속초시': 4, '강원도 양구군': 6,
    '강원도 양양군': 4, '강원도 영월군': 6, '강원도 원주시': 25,
    '강원도 인제군': 5, '강원도 정선군': 7, '강원도 철원군': 7,
    '강원도 춘천시': 25, '강원도 태백시': 5, '강원도 평창군': 7,
    '강원도 홍천군': 9, '강원도 화천군': 5, '강원도 횡성군': 10,
    // 충북 (약 100개교)
    '충청북도 괴산군': 4, '충청북도 단양군': 4, '충청북도 보은군': 4,
    '충청북도 영동군': 6, '충청북도 옥천군': 4, '충청북도 음성군': 7,
    '충청북도 제천시': 11, '충청북도 증평군': 4, '충청북도 진천군': 8,
    '충청북도 청주시': 40, '충청북도 충주시': 15,
    // 충남 (약 120개교)
    '충청남도 계룡시': 17, '충청남도 공주시': 14, '충청남도 금산군': 11,
    '충청남도 논산시': 18, '충청남도 당진시': 13, '충청남도 보령시': 10,
    '충청남도 부여군': 7, '충청남도 서산시': 17, '충청남도 서천군': 7,
    '충청남도 아산시': 20, '충청남도 예산군': 7, '충청남도 천안시': 35,
    '충청남도 청양군': 5, '충청남도 태안군': 7, '충청남도 홍성군': 9,
    // 전북 (약 110개교)
    '전라북도 고창군': 7, '전라북도 군산시': 22, '전라북도 김제시': 10,
    '전라북도 남원시': 10, '전라북도 무주군': 6, '전라북도 부안군': 7,
    '전라북도 순창군': 5, '전라북도 완주군': 10, '전라북도 익산시': 18,
    '전라북도 임실군': 5, '전라북도 장수군': 5, '전라북도 전주시': 30,
    '전라북도 정읍시': 11, '전라북도 진안군': 6,
    // 전남 (약 140개교)
    '전라남도 강진군': 5, '전라남도 고흥군': 7, '전라남도 곡성군': 5,
    '전라남도 광양시': 11, '전라남도 구례군': 5, '전라남도 나주시': 14,
    '전라남도 담양군': 5, '전라남도 목포시': 16, '전라남도 무안군': 9,
    '전라남도 보성군': 6, '전라남도 순천시': 21, '전라남도 신안군': 4,
    '전라남도 여수시': 21, '전라남도 영광군': 7, '전라남도 영암군': 7,
    '전라남도 완도군': 6, '전라남도 장성군': 5, '전라남도 장흥군': 7,
    '전라남도 진도군': 5, '전라남도 함평군': 5, '전라남도 해남군': 7,
    '전라남도 화순군': 12,
    // 경북 (약 170개교)
    '경상북도 경산시': 14, '경상북도 경주시': 13, '경상북도 고령군': 8,
    '경상북도 구미시': 30, '경상북도 군위군': 3, '경상북도 김천시': 25,
    '경상북도 문경시': 10, '경상북도 봉화군': 6, '경상북도 상주시': 15,
    '경상북도 성주군': 8, '경상북도 안동시': 20, '경상북도 영덕군': 7,
    '경상북도 영양군': 5, '경상북도 영주시': 13, '경상북도 영천시': 10,
    '경상북도 예천군': 8, '경상북도 울릉군': 4, '경상북도 울진군': 7,
    '경상북도 의성군': 10, '경상북도 청도군': 8, '경상북도 청송군': 5,
    '경상북도 칠곡군': 12, '경상북도 포항시': 35,
    // 경남 (약 180개교)
    '경상남도 거제시': 11, '경상남도 거창군': 5, '경상남도 고성군': 8,
    '경상남도 김해시': 20, '경상남도 남해군': 6, '경상남도 밀양시': 11,
    '경상남도 사천시': 10, '경상남도 산청군': 7, '경상남도 양산시': 18,
    '경상남도 의령군': 6, '경상남도 진주시': 21, '경상남도 창녕군': 10,
    '경상남도 창원시': 30, '경상남도 통영시': 12, '경상남도 하동군': 6,
    '경상남도 함안군': 8, '경상남도 함양군': 6, '경상남도 합천군': 7,
    // 제주 (약 40개교)
    '제주특별자치도 서귀포시': 15, '제주특별자치도 제주시': 28,
  };

  console.log('2. 데이터 정제 중...\n');

  const cleanedData = {
    2025: {}
  };

  let totalRegions = 0;
  let totalSchools = 0;
  let trimmedRegions = [];

  Object.entries(regions).forEach(([region, schools]) => {
    const expectedCount = expectedCounts[region] || 50; // 기본값 50개

    // 학교명 기반 중복 제거
    const uniqueMap = new Map();
    schools.forEach(school => {
      const key = `${school.name}_${school.rank}`;
      if (!uniqueMap.has(key)) {
        uniqueMap.set(key, school);
      }
    });

    const uniqueSchools = Array.from(uniqueMap.values());

    // 예상 개수보다 많으면 자르기
    if (uniqueSchools.length > expectedCount) {
      cleanedData[2025][region] = uniqueSchools.slice(0, expectedCount);
      trimmedRegions.push({
        region,
        original: uniqueSchools.length,
        kept: expectedCount
      });
    } else {
      cleanedData[2025][region] = uniqueSchools;
    }

    if (cleanedData[2025][region].length > 0) {
      totalRegions++;
      totalSchools += cleanedData[2025][region].length;
    }
  });

  console.log('\n3. 정제 결과 요약:\n');
  console.log(`   총 지역 수: ${totalRegions}개`);
  console.log(`   총 학교 수: ${totalSchools}개교`);

  if (trimmedRegions.length > 0) {
    console.log(`\n   자른 지역 (${trimmedRegions.length}개):`);
    trimmedRegions.forEach(p => {
      console.log(`     - ${p.region}: ${p.original}개 → ${p.kept}개`);
    });
  }

  // 정제된 데이터 저장 (원본 파일 덮어쓰기)
  const cleanedPath = path.join(__dirname, '../src/data/schoolAlimData.json');
  fs.writeFileSync(cleanedPath, JSON.stringify(cleanedData, null, 2), 'utf8');
  console.log(`\n4. 정제된 데이터 저장 완료: ${cleanedPath}`);

  console.log('\n=== 정제 완료 ===\n');

  return cleanedData;
}

// 실행
(async () => {
  try {
    cleanDuplicateDataV2();
  } catch (error) {
    console.error('\n오류 발생:', error.message);
    console.error(error.stack);
  }
})();
